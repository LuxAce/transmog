<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Finding Aid Converter</title>

    <script src="js/jquery-2.1.3.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/bootstrap.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">

    <script type="text/javascript">

        var schemaList;

        var schema;

        var openDocumentId;

        $(document).ready(function(){
            $('#documents_form').hide();
            $('#loading_documents').show();
            $.ajax({ url: "service/findingaids",
                context: document.body,
                success: function(json) {
                    $.each(json, function(i, value) {
                        $('#doc_selector').append($('<option>').text(value).attr('value', value));
                    });
                    $('#loading_documents').hide();
                    $('#documents_form').show();
                }});

            $('#select_document').click(loadDocumentFromSelector);
            $('#upload_button').submit(uploadFile);

            loadSchema();
        });

        function loadSchema() {
            $.ajax({ url: "service/findingaids/schema",
                context: document.body,
                success: function(json) {
                    schemaList = json;
                    for (var key in json) {
                        $('#profile').prepend($('<option>' + key + '</option>'))
                    }
                }});
        }

        function loadDocumentFromSelector() {
            docid = document.getElementById("doc_selector").value;
            loadDocumentById(docid);
        }

        function loadDocumentById(docid) {
            $('#workspace').hide();
            $('#loading_document').show();
            $.ajax({ url: "service/findingaids/" + docid,
                context: document.body,
                headers: {
                    Accept : "text/html; charset=utf-8"
                },
                accepts: "text/html",
                dataType: "html",
                success: function(html) {
                    openDocumentId = docid;
                    $('#workspace').replaceWith("<div class=\"row\" id=\"workspace\"><h4>Working Document</h4>" + html + "</div>");

                    schema = schemaList[$('#profile-name').text()];

                    markUpDiv($('.ROOT').find(".UNASSIGNED, .ASSIGNED, .UNASSIGNED_TABLE"));

                    $('.ROOT').addClass('well');
                    addDropZones($('.ROOT'));

                    // add a download button
                    $('<button type="button" class="btn btn-default" aria-label="Left Align" id="download_ead"><span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span> Download EAD XML</button>').insertAfter($('.ROOT'))

                    $('#download_ead').unbind();
                    $('#download_ead').click(function() {
                        var win = window.open('service/findingaids/' + docid + '/ead', '_blank');
                    });

                    // make it visible
                    $('#loading_document').hide();
                    $('#workspace').show();
                }});
        }

        function markUpDiv(jquery) {
            // format the HTML and add labels and functions
            jquery.each(function() {
                var div = $(this);
                if (div.hasClass('UNASSIGNED')) {
                    addToolbarForUnassigned(div);
                } else if (div.hasClass('ASSIGNED')) {
                    addToolbarForAssigned(div);
                } else if (div.hasClass('UNASSIGNED_TABLE')) {
                    addToolbarForTable(div);

                }
            });

            // attach assignment handler
            $('.type-assignment', jquery).change(assignType);
        }

        function addDropZones(div) {
            var dropTargets = div.find('>.UNASSIGNED, >.ASSIGNED, >.UNASSIGNED_TABLE');
            dropTargets.each(function(index) {
                $(this).before('<div class="drop-zone index-' + index + '" />');
                if (index == dropTargets.size() - 1) {
                    $(this).after('<div class="drop-zone index-' + (index + 1) + '" />');
                }
            });
            if (dropTargets.size() == 0) {
                div.append('<div class="drop-zone index-0" />');
            }

            div.find(".drop-zone").each(function() {
                $(this).droppable({
                    greedy: true,
                    hoverClass: "drop-hover",
                    drop: dropComponent
                });

            });
        }

        function getDropZoneIndex(dropzoneDiv) {
            var index = 0;
            var classes = dropzoneDiv.attr("class").split(' ');
            for (i = 0; i < classes.length; i ++) {
                if (classes[i].indexOf("index-") == 0) {
                    index = parseInt(classes[i].substring(6))
                    break;
                }
            }
            return index;
        }

        function dropComponent(event, ui) {
            var partId = ui.draggable.attr("id");
            var newParentId = $(this).parent().attr("id");
            var index = getDropZoneIndex($(this));
            $.ajax({
                type: "MOVE",
                url: "service/findingaids/" +openDocumentId + "/" + partId + "?newParent=" + newParentId + "&index=" + index,
                data: ui.draggable.find("textarea").val(),
                success: function(htmlFragment) {
                    ui.draggable.remove();
                    replaceDocumentElement(htmlFragment);
                }
            });
        }

        function addToolbarForAssigned(div) {
            var type = getPartType($(div));
            var label = getLabel(type);
            if (div.find(".ASSIGNED, .UNASSIGNED").size() == 0) {
                div.prepend('<div class="top-bar"><span class="section-label">' + label + '</span> <a href="javascript:noop()" class="reassign">(edit)</a> <a href="javascript:noop()" class="insert">(add child)</a></div>');
                div.find('>.top-bar>.reassign').click(function() {
                    var link = $(this);
                    var partId = link.parent().parent().attr('id');
                    var type = "UNASSIGNED";
                    $.ajax({
                        type: "PUT",
                        url: "service/findingaids/" +openDocumentId + "/" + partId + "?type=" + type,
                        data: "",
                        success: replaceDocumentElement
                    });
                    return;
                });
            } else {
                div.prepend('<div class="top-bar"><span class="section-label">' + label + '</span> <a href="javascript:noop()" class="insert">(add child)</a></div>');
            }
            div.find('>.top-bar>.insert').click(function() {
                var link = $(this);
                var index = getDropZoneIndex($(this).parent());
                var partId = link.parent().parent().attr('id');
                $.ajax({
                    type: "POST",
                    url: "service/findingaids/" + openDocumentId + "/" + partId + "/new?index=" + index,
                    data: "",
                    success: replaceDocumentElement
                });
                return;

            });
            addDropZones(div);
        }

        function addToolbarForUnassigned(div) {
            var contents = div.text();
            var parentType = getPartType(div.parent());
            div.html("<textarea>" + contents + "</textarea>");

            var toolbar = '<div class="top-bar"><select class="type-assignment"><option>Select type...</option>';
            if (parentType in schema) {
                for (i = 0; i < schema[parentType]["possibleChildren"].length; i++) {
                    toolbar += '<option value="' + schema[parentType]["possibleChildren"][i] + '">' + getLabel(schema[parentType]["possibleChildren"][i]) + '</option>';
                }
            }
            toolbar += '</select> <a href="javascript:noop()" class="delete">(delete)</a></div>';
            div.prepend($(toolbar));

            div.find('>.top-bar>.delete').click(function() {
                var link = $(this);
                var partId = link.parent().parent().attr('id');
                $.ajax({
                    type: "DELETE",
                    url: "service/findingaids/" + openDocumentId + "/" + partId,
                    data: "",
                    success: replaceDocumentElement
                });
                return;

            });

            div.draggable( {
                cursor: 'move',
                revert: "invalid"
            } );

        }

        function addToolbarForTable(div) {
            var parentType = getPartType(div.parent());

            var table = div.find(">table");
            table.addClass("table");
            table.addClass("table-bordered");
            table.addClass("table-striped");

            var toolbar = '<span>Treat each row as a:</span><div class="top-bar"><select class="table-type-assignment"><option>Select type...</option>';
            if (parentType in schema) {
                for (i = 0; i < schema[parentType]["possibleChildren"].length; i++) {
                    toolbar += '<option value="' + schema[parentType]["possibleChildren"][i] + '">' + getLabel(schema[parentType]["possibleChildren"][i]) + '</option>';
                }
            }
            toolbar += '</select> </div> <button class=".btn table-assignment-button">Apply</button>';
            div.prepend($(toolbar));

            var header = '<thead><tr>';
            for (column = 0; column < table.find("tr:first td").length; column ++) {
                header += '<th>' + getHtmlStringForRowTypeAssignment(parentType) +  '</th>';
            }
            header += '</tr></thead>'
            table.prepend($(header));

            div.draggable( {
                cursor: 'move',
                revert: "invalid"
            } );

            // attach assignment handlers
            div.find(".table-type-assignment").change(selectTableAssignment);
            $('.table-assignment-button').click(assignTable);
        }

        function selectTableAssignment() {
            var option = $(this);
            console.log("changed value to " + option.val());
            option.parent().parent().find(".row-type-assignment").each(function() {
                var select = $(this);
                var oldval = select.val();
                select.replaceWith($(getHtmlStringForRowTypeAssignment(option.val())));
            });
        }

        function getHtmlStringForRowTypeAssignment(parentType) {
            // TODO: only include text types
            var select = '<select class="row-type-assignment"><option>Select type for column...</option>';
            if (parentType in schema) {
                for (i = 0; i < schema[parentType]["possibleChildren"].length; i ++) {
                    select += '<option value="' + schema[parentType]["possibleChildren"][i] + '">' + getLabel(schema[parentType]["possibleChildren"][i]) + '</option>';
                }
            }
            select += '</select>';
            return select;
        }

        function assignTable() {
            var button = $(this);
            var tableDiv = button.parent();
            var partId = tableDiv.attr("id");
            var option = tableDiv.find(".table-type-assignment");
            if (option.val() == "Select type...") {
                alert("You must select a type to be applied to each row in the table!");
                return;
            }
            var query = 'rowType=' + option.val();
            tableDiv.find(".row-type-assignment").each(function() {
                var select = $(this);
                if (select.val() == "Select type for column...") {
                    alert("Must select type for column!");
                    return;
                }
                query += "&colTypes=" + select.val();

            });
            $.ajax({
                type: "PUT",
                url: "service/findingaids/" + openDocumentId + "/" + partId + "/table?" + query,
                data: "",
                success: replaceDocumentElement
            });
            return;
        }

        function noop() {

        }

        function assignType() {
            var link = $(this);
            var partId = link.parent().parent().attr('id');
            var selectedType = link.val();
            console.log("SelectedType: " + selectedType);
            var canContainText = schema[selectedType]["canContainText"];
            console.log("docId=" + openDocumentId + ", partId=" + partId + ", selectedPartType=" + selectedType + ", canContainText=" + canContainText);
            $.ajax({
                type: canContainText ? "PUT" : "POST",
                url: "service/findingaids/" +openDocumentId + "/" + partId + "?type=" + selectedType,
                data: link.parent().parent().find("textarea").val(),
                success: replaceDocumentElement
            });
            return;
        }

        function replaceDocumentElement(htmlFragment) {
            var html = $("<div />").html(htmlFragment).children();
            console.log(html);
            var id = html.attr("id");
            console.log("id to be relpaced " + id);
            $('#' + id).replaceWith(html);
            markUpDiv($('#' + id));
            markUpDiv($('#' + id).find("div.ASSIGNED"));
            markUpDiv($('#' + id).find("div.UNASSIGNED"));
            markUpDiv($('#' + id).find("div.UNASSIGNED_TABLE"));
        }

        function getPartType(jquery) {
            return jquery.attr('class').split(' ')[0];
        }

        function getLabel(partType) {
            return schema[partType]["label"];
        }



        function uploadFile() {
            var update_file = document.getElementById("file").files[0];
            var schema_id = $("#profile").val();
            var reader = new FileReader();
            var xhr = new XMLHttpRequest();
            $('#workspace').hide();
            $('#loading_document').show();
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        var docid = xhr.getResponseHeader('Content-Location');
                        docid = docid.substring(docid.indexOf('/') + 1);
                        $('#doc_selector').append($('<option>').text(docid).attr('value', docid));
                        loadDocumentById(docid);
                    } else {
                        alert("Error submitting file!");
                    }
                }
            };

            xhr.open( "POST", "service/findingaids/" + update_file.name + "?schemaId=" + schema_id);

            xhr.setRequestHeader("Content-type", update_file.type || "application/octet-stream");
            reader.onload = function(e) {
                var result = e.target.result;
                var data = new Uint8Array(result.length);
                for (var i = 0; i < result.length; i++) {
                    data[i] = (result.charCodeAt(i) & 0xff);
                }
                xhr.send(data.buffer);
            };
            reader.readAsBinaryString(update_file);
        }

    </script>

</head>
<body>
  <div class="container">
    <div class="header">
        <!--
        <nav>
            <ul class="nav nav-pills pull-right">
                <li role="presentation" class="active"><a href="#">Home</a></li>
                <li role="presentation"><a href="#">About</a></li>
                <li role="presentation"><a href="#">Contact</a></li>
            </ul>
        </nav>
        -->
        <h3 class="text-muted">Finding Aid Processor</h3>
    </div>

    <div class="row" id="load-options">
        <div class="col-lg-6">
            <h4>Start a NEW document</h4>
            <p>Upload a word document to serve as the starting point for your new structured XML document.</p>

            <form action="javascript:uploadFile()">
                <div>
                    <label for="profile" class="control-label">Profile</label>
                    <select id="profile"></select>
                </div>
                <div>
                    <label for="file" class="control-label">File</label>
                    <input type="file" id="file" />
                    <input type="submit" class="btn btn-default" value="Upload" id="upload_button">
                </div>
            </form>
        </div>

        <div class="col-lg-6">
            <h4>Continue a previous document</h4>
            <p>
                You may select a previously submitted document to continue working on
                or to download as EAD XML.
            </p>
            <div id="loading_documents">
                <p><img src="ajax-loader.gif" /> Loading Document List</p>
            </div>
            <form id="documents_form">
                <div class="input-group">
                    <select id="doc_selector" class="form-control"></select>
                    <span class="input-group-btn">
                        <button class="btn btn-default" id="select_document" type="button">Go!</button>
                    </span>
                </div>
            </form>
        </div>
    </div>

      <div class="row" id="loading_document" style="display:none;">
          <p>
              <img src="ajax-loader.gif" /> Loading document...
          </p>
      </div>
      <div class="row" id="workspace">
      </div>

  </div> <!-- /container -->

</body>
</html>